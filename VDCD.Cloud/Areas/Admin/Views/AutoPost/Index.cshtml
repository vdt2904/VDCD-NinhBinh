@{
    ViewData["Title"] = "Quản lý đăng bài Facebook";

    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.ckeditor.com/ckeditor5/40.0.0/classic/ckeditor.js"></script>

<div class="container-fluid px-4">
    <!-- Header -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card bg-primary text-white">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fa-brands fa-facebook me-2"></i>Quản lý đăng bài Facebook - VDCD Group
                    </h4>
                    <button class="btn btn-light" onclick="openFBEditor()">
                        <i class="fa-solid fa-plus me-2"></i>Thêm bài viết mới
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Báo cáo đơn giản: Bài đã đăng, đã duyệt và chờ duyệt -->
    <div class="row mt-4">
        <div class="col-md-4">
            <div class="card border-left-primary">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="text-muted mb-2">Bài đã đăng</h6>
                            <h2 class="mb-0" id="totalPosted">0</h2>
                        </div>
                        <div class="bg-primary bg-opacity-10 p-3 rounded">
                            <i class="fa-solid fa-check-circle fa-2x text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-left-success">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="text-muted mb-2">Bài đã duyệt</h6>
                            <h2 class="mb-0" id="approvedCount">0</h2>
                        </div>
                        <div class="bg-success bg-opacity-10 p-3 rounded">
                            <i class="fa-solid fa-check-double fa-2x text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-left-warning">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="text-muted mb-2">Bài chờ duyệt</h6>
                            <h2 class="mb-0" id="pendingCount">0</h2>
                        </div>
                        <div class="bg-warning bg-opacity-10 p-3 rounded">
                            <i class="fa-solid fa-clock fa-2x text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Danh sách bài viết -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fa-regular fa-newspaper me-2"></i>Danh sách bài viết
                        </h5>
                        <div class="d-flex gap-2 flex-wrap">
                            <input type="text" class="form-control form-control-sm" style="width:200px" placeholder="Tìm kiếm tiêu đề..." id="searchInput">

                            <select class="form-select form-select-sm" style="width:150px" id="statusFilter">
                                <option value="">Tất cả trạng thái</option>
                                <option value="1">Chờ duyệt</option>
                                <option value="2">Đã duyệt</option>
                                <option value="3">Đã đăng</option>
                            </select>

                            <select class="form-select form-select-sm" style="width:150px" id="typeFilter">
                                <option value="">Tất cả loại</option>
                                <option value="activity">📸 Hoạt động</option>
                                <option value="event">🎉 Sự kiện</option>
                                <option value="recruitment">💼 Tuyển dụng</option>
                                <option value="tech">💡 Công nghệ</option>
                                <option value="partner">🤝 Đối tác</option>
                                <option value="other">📝 Khác</option>
                            </select>

                            <select class="form-select form-select-sm" style="width:180px" id="userFilter">
                                <option value="">Tất cả người đăng</option>
                                <!-- Options sẽ được load động từ users array -->
                            </select>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="postsTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Tiêu đề</th>
                                    <th>Loại</th>
                                    <th>Lịch đăng</th>
                                    <th>Trạng thái</th>
                                    <th>Người đăng</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <!-- Data will be loaded dynamically -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Phân trang -->
                    <div class="d-flex justify-content-between align-items-center p-3 border-top">
                        <div class="text-muted small">
                            Hiển thị <span id="pageStart">0</span> - <span id="pageEnd">0</span> trên tổng số <span id="totalRecords">0</span> bài viết
                        </div>
                        <nav aria-label="Page navigation">
                            <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
                        </nav>
                        <div class="d-flex align-items-center gap-2">
                            <span class="text-muted small">Hiển thị:</span>
                            <select class="form-select form-select-sm" style="width:70px" id="pageSize">
                                <option value="5" selected>5</option>
                                <option value="10">10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hiển thị lịch đăng dạng lịch tuần -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fa-regular fa-calendar me-2"></i>Lịch đăng bài
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mt-2">
                        <div class="week-scroll-container">
                            <div class="week-scroll-wrapper" id="weeklySchedule">
                                <!-- Weekly schedule will be loaded dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Editor Bài viết Facebook -->
<div class="modal fade" id="fbEditorModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold">
                    <i class="fa-brands fa-facebook text-primary me-2"></i>
                    <span id="editorModalTitle">THÊM BÀI VIẾT MỚI</span>
                </h5>
                <div class="d-flex gap-2 ms-auto me-2">
                    <button class="btn btn-sm btn-outline-success" type="button" onclick="generateAIContent()">
                        <i class="bi bi-magic me-1"></i>Tạo nội dung tự động
                    </button>
                    <button class="btn btn-sm btn-outline-info" type="button" onclick="previewCurrentPost()">
                        <i class="bi bi-eye me-1"></i>Xem trước
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body p-4">
                <form id="fbPostForm">
                    <input type="hidden" id="fbPostId" value="0" />
                    <input type="hidden" id="fbImageUrls" value="" />
                    <input type="hidden" id="fbVideoUrls" value="" />

                    <div class="row">
                        <div class="col-md-8">
                            <!-- Tiêu đề bài viết -->
                            <div class="form-group mb-3">
                                <label class="fw-bold">Tiêu đề bài viết <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="fbPostTitle" placeholder="Nhập tiêu đề bài viết...">
                            </div>

                            <!-- Loại nội dung -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="fw-bold">Loại nội dung</label>
                                    <select class="form-select" id="fbPostType">
                                        <option value="activity">📸 Bài chia sẻ hoạt động CBCNV</option>
                                        <option value="event">🎉 Thông báo sự kiện/workshop</option>
                                        <option value="recruitment">💼 Thông tin tuyển dụng</option>
                                        <option value="tech">💡 Chia sẻ công nghệ</option>
                                        <option value="partner">🤝 Giới thiệu đối tác</option>
                                        <option value="other">📝 Nội dung khác</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Nội dung bài viết - CKEditor -->
                            <div class="form-group mb-3">
                                <label class="fw-bold">Nội dung bài viết</label>
                                <textarea id="fbEditor" name="fbEditor"></textarea>
                            </div>
                        </div>

                        <div class="col-md-4 border-start">
                            <!-- Ảnh bài viết -->
                            <div class="form-group mb-3">
                                <label class="fw-bold d-block">Ảnh bài viết</label>
                                <div class="multiple-image-container border rounded p-2 mb-2">
                                    <div class="image-grid d-flex flex-wrap gap-2 mb-2" id="fbImageGrid">
                                        <!-- Ảnh sẽ được thêm vào đây bằng JavaScript -->
                                        <div class="image-placeholder text-center p-3 bg-light rounded" style="width:80px; height:80px; cursor:pointer;" onclick="openFBFileManager('image')">
                                            <i class="bi bi-plus-circle text-muted"></i>
                                            <small class="d-block">Thêm ảnh</small>
                                        </div>
                                    </div>
                                    <div class="d-grid">
                                        <button class="btn btn-outline-primary btn-sm" type="button" onclick="openFBFileManager('image')">
                                            <i class="bi bi-images me-1"></i>Chọn nhiều ảnh
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Video bài viết -->
                            <div class="form-group mb-3">
                                <label class="fw-bold d-block">Video bài viết</label>
                                <div class="multiple-video-container border rounded p-2 mb-2">
                                    <div class="video-grid d-flex flex-wrap gap-2 mb-2" id="fbVideoGrid">
                                        <!-- Video sẽ được thêm vào đây bằng JavaScript -->
                                        <div class="video-placeholder text-center p-3 bg-light rounded" style="width:80px; height:80px; cursor:pointer;" onclick="openFBFileManager('video')">
                                            <i class="bi bi-plus-circle text-muted"></i>
                                            <small class="d-block">Thêm video</small>
                                        </div>
                                    </div>
                                    <div class="d-grid">
                                        <button class="btn btn-outline-danger btn-sm" type="button" onclick="openFBFileManager('video')">
                                            <i class="bi bi-camera-video me-1"></i>Chọn video
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Lịch đăng trong editor (chỉ 1 lịch) -->
                            <div class="form-group mb-3">
                                <label class="fw-bold">Lịch đăng</label>
                                <div class="border rounded p-3">
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <input type="date" class="form-control" id="scheduleDate" value="@DateTime.Now.AddDays(1).ToString("yyyy-MM-dd")">
                                        </div>
                                        <div class="col-md-6">
                                            <input type="time" class="form-control" id="scheduleTime" value="09:00">
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">Gợi ý khung giờ vàng: </small>
                                        <div class="d-flex gap-2 mt-1">
                                            <button class="btn btn-sm btn-outline-warning" type="button" onclick="setGoldenHour('09:00')">9:00</button>
                                            <button class="btn btn-sm btn-outline-warning" type="button" onclick="setGoldenHour('12:00')">12:00</button>
                                            <button class="btn btn-sm btn-outline-warning" type="button" onclick="setGoldenHour('20:00')">20:00</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>

                <!-- Nút Chờ duyệt - chỉ hiển thị với ContentManager -->
                <button type="button" class="btn btn-warning me-2" onclick="saveAsDraft()" id="draftButton">
                    <i class="fa-regular fa-floppy-disk me-1"></i>Chờ duyệt
                </button>

                <!-- Nút Duyệt - chỉ hiển thị với SuperAdmin -->
                <button type="button" class="btn btn-primary px-4" onclick="saveAndSchedule()" id="approveButton">
                    <i class="fa-regular bi bi-calendar-check"></i> Duyệt
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Preview Bài viết Facebook (đơn giản) -->
<div class="modal fade" id="fbPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white py-2">
                <h6 class="modal-title">
                    <i class="fa-brands fa-facebook me-1"></i>Xem trước bài viết
                </h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Bài viết Facebook đơn giản -->
                <div class="facebook-post">
                    <!-- Header: Avatar + Tên trang + Thời gian -->
                    <div class="post-header d-flex align-items-center p-3">
                        <div class="avatar me-2">
                            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center text-white" style="width: 40px; height: 40px;">
                                <i class="fa-brands fa-facebook-f"></i>
                            </div>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold">VDCD Group</h6>
                            <small class="text-muted" id="previewDateTime">Vừa xong</small>
                        </div>
                    </div>

                    <!-- Nội dung bài viết -->
                    <div class="post-content px-3 pb-2">
                        <!-- Text nội dung -->
                        <div class="post-text mb-2" id="previewContent" style="font-size: 14px; line-height: 1.5;"></div>

                        <!-- Ảnh đính kèm -->
                        <div class="post-images mt-2" id="previewImages"></div>

                        <!-- Video đính kèm -->
                        <div class="post-videos mt-2" id="previewVideos"></div>

                    </div>

                    <!-- Footer với các nút tương tác (đơn giản) -->
                    <div class="post-footer border-top px-3 py-2 d-flex justify-content-around text-muted small">
                        <span><i class="fa-regular fa-thumbs-up me-1"></i>Thích</span>
                        <span><i class="fa-regular fa-comment me-1"></i>Bình luận</span>
                        <span><i class="fa-regular fa-share-from-square me-1"></i>Chia sẻ</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer py-2">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal File Manager -->
<div class="modal fade" id="fbFileManagerModal" tabindex="-1" aria-hidden="true" style="z-index:1070;">
    <div class="modal-dialog modal-xl modal-dialog-centered" style="height:90vh;">
        <div class="modal-content h-100 shadow-lg">
            <div class="modal-header">
                <h5 class="modal-title">Quản lý file</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0 h-100">
                <iframe id="fbFileManagerIframe" src="/Admin/FileManager/Index" style="width:100%; height:100%; border:none;"></iframe>
            </div>
        </div>
    </div>
</div>

<script>
    let fbFmType = 'image';
    let currentFBPostId = 0;
    let selectedImages = [];
    let selectedVideos = [];
    let editorInstance = null;
    let currentPage = 1;
    let pageSize = 5;
    let totalPages = 1;
    let allPosts = []; // Lưu tất cả bài viết để thống kê
    let users = [];
    let currentUser = null;
    let currentUserId = null;

    @if (ViewBag.ListUser != null)
    {
        <text>
                users = @Html.Raw(Json.Serialize(ViewBag.ListUser));
        </text>
    }
        // Hàm lấy thông tin user hiện tại
        function getCurrentUser() {
            $.ajax({
                url: '/admin/account/getcurrentuser',
                type: 'GET',
                async: false, // Đồng bộ để đảm bảo có dữ liệu trước khi render
                success: function (response) {
                    currentUser = response;
                    currentUserId = response.userId;
                    console.log('Current user:', currentUser);
                },
                error: function () {
                    console.error('Không thể lấy thông tin user');
                }
            });
        }

    // Hàm kiểm tra quyền
    function hasPermission(action) {
        if (!currentUser) return false;

        const role = currentUser.userRole;

        switch (action) {
            case 'approve': // Quyền duyệt bài
                return role === 'SuperAdmin';
            case 'edit': // Quyền sửa bài
                return role === 'ContentManager' || role === 'SuperAdmin';
            case 'create': // Quyền tạo bài
                return role === 'ContentManager' || role === 'SuperAdmin';
            case 'recall': // Quyền thu hồi bài (chuyển về chờ duyệt)
                return role === 'ContentManager';
            case 'delete': // Quyền xóa bài
                return role === 'ContentManager' || role === 'SuperAdmin';
            default:
                return false;
        }
    }

        // Hàm lấy tên user theo ID
        function getUserNameById(userId) {
            if (!userId) return 'N/A';

            console.log('Looking for userId:', userId);
            console.log('Type of userId:', typeof userId);
            console.log('Users array:', users);

            // Không cần parseInt vì userId có thể là string
            // So sánh trực tiếp (== thay vì ===) để tự động convert kiểu
            const user = users.find(u => u.userId == userId);
            console.log('Found user:', user);

            return user ? user.fullName : 'N/A';
        }

    // Base URL để thêm vào đường dẫn ảnh
    const baseUrl = window.location.origin; // Lấy domain hiện tại (http://localhost:port)

    // Khởi tạo CKEditor
    async function initCKEditor() {
        const editorElement = document.querySelector('#fbEditor');

        if (!editorElement) return;

        // Xóa CKEditor cũ nếu có
        if (editorInstance) {
            await editorInstance.destroy();
            editorInstance = null;
        }

        try {
            editorInstance = await ClassicEditor.create(editorElement, {
                toolbar: {
                    items: [
                        'heading', '|',
                        'bold', 'italic', 'link', 'bulletedList', 'numberedList', '|',
                        'blockQuote', 'insertTable', '|',
                        'undo', 'redo'
                    ],
                    shouldNotGroupWhenFull: true
                },
                language: 'vi',
                placeholder: 'Nhập nội dung bài viết...',
                table: {
                    contentToolbar: ['tableColumn', 'tableRow', 'mergeTableCells']
                },
                removePlugins: ['Title'],
                initialData: $('#fbEditor').val() || ''
            });

            console.log('CKEditor initialized successfully');
        } catch (error) {
            console.error('Lỗi khởi tạo CKEditor:', error);
        }
    }

    // Load danh sách bài viết
    function loadPosts(page = 1) {
        $.ajax({
            url: '/Admin/Facebook/GetAll',
            type: 'GET',
            data: {
                page: page,
                pagesize: pageSize
            },
            success: function (response) {
                if (response.success) {
                    // Lưu dữ liệu trang hiện tại để hiển thị
                    renderPosts(response.data);
                    updatePagination(response.page, response.totalPages, response.total);

                    // Gọi API riêng để lấy tất cả bài viết cho thống kê và lịch tuần
                    $.ajax({
                        url: '/Admin/Facebook/GetAll',
                        type: 'GET',
                        data: {
                            page: 1,
                            pagesize: 1000 // Lấy tối đa 1000 bài để thống kê và lịch tuần
                        },
                        success: function (allResponse) {
                            if (allResponse.success) {
                                allPosts = allResponse.data;
                                updateStats(allPosts);
                                updateWeeklySchedule(allPosts); // Cập nhật lịch tuần với tất cả dữ liệu
                                loadUserFilter();
                            }
                        }
                    });
                }
            },
            error: function () {
                toastr.error('Không thể tải danh sách bài viết');
            }
        });
    }

    // Thống kê theo toàn bộ dữ liệu
    function updateStats(posts) {
        // Đếm bài đã đăng (status = 3)
        const totalPosted = posts.filter(p => p.status === 3).length;

        // Đếm bài đã duyệt (status = 2)
        const approvedCount = posts.filter(p => p.status === 2).length;

        // Đếm bài chờ duyệt (status = 1)
        const pendingCount = posts.filter(p => p.status === 1).length;

        $('#totalPosted').text(totalPosted);
        $('#approvedCount').text(approvedCount);
        $('#pendingCount').text(pendingCount);
    }
    // Refresh thống kê tổng
    function refreshStats() {
        $.ajax({
            url: '/Admin/Facebook/GetAll',
            type: 'GET',
            data: {
                page: 1,
                pagesize: 1000 // Lấy tối đa 1000 bài để thống kê
            },
            success: function (response) {
                if (response.success) {
                    allPosts = response.data;
                    updateStats(allPosts);
                    updateWeeklySchedule(allPosts);
                }
            }
        });
    }

    // Render posts to table
    function renderPosts(posts) {
        const tbody = $('#tableBody');
        tbody.empty();

        posts.forEach(post => {
            const statusClass = getStatusClass(post.status);
            const statusText = getStatusText(post.status);
            const typeBadge = getTypeBadge(post.typePost);

            // Format scheduled date
            let scheduleDate = 'Chưa có lịch';
            if (post.scheduledDate) {
                const date = new Date(post.scheduledDate);
                scheduleDate = date.toLocaleDateString('vi-VN') + ' ' +
                    date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            }

            // Lấy tên người dùng từ users array
            let nguoiDang = 'N/A';
            if (post.userCreateId) {
                nguoiDang = getUserNameById(post.userCreateId);
            } else if (post.userCreate?.fullName) {
                nguoiDang = post.userCreate.fullName;
            }

            // Kiểm tra quyền sở hữu
            const isOwner = currentUserId && post.userCreateId && currentUserId == post.userCreateId;
            const isSuperAdmin = currentUser?.userRole === 'SuperAdmin';

            // Xây dựng các nút thao tác
            let actionButtons = '';

            // Nút sửa - SuperAdmin sửa được tất cả, ContentManager chỉ sửa bài của mình
            if (post.status !== 3) {
                if (isSuperAdmin || (isOwner && currentUser?.userRole === 'ContentManager')) {
                    actionButtons += `
                        <button class="btn btn-sm btn-outline-primary" onclick="editFBPost(${post.id})" title="Sửa bài viết">
                            <i class="bi bi-pencil"></i>
                        </button>
                    `;
                }
            }

            // Nút xem trước - ai cũng xem được
            actionButtons += `
                <button class="btn btn-sm btn-outline-info" onclick="previewFBPost(${post.id})" title="Xem trước">
                    <i class="bi bi-eye"></i>
                </button>
            `;

            // SUPERADMIN: Nút duyệt (khi bài ở trạng thái chờ duyệt)
            if (isSuperAdmin && post.status === 1) {
                actionButtons += `
                    <button class="btn btn-sm btn-outline-success" onclick="approvePost(${post.id})" title="Duyệt bài">
                        <i class="bi bi-check-lg"></i>
                    </button>
                `;
            }

            // CONTENT MANAGER: Nút thu hồi (chỉ bài của mình và ở trạng thái đã duyệt)
            if (currentUser?.userRole === 'ContentManager' && isOwner && post.status === 2) {
                actionButtons += `
                    <button class="btn btn-sm btn-outline-warning" onclick="recallPost(${post.id})" title="Thu hồi về chờ duyệt">
                        <i class="bi bi-arrow-return-left"></i>
                    </button>
                `;
            }

            // Nút xóa - xử lý theo phân quyền
            if (isSuperAdmin) {
                // SuperAdmin: xóa hẳn mọi trạng thái
                actionButtons += `
                    <button class="btn btn-sm btn-outline-danger" onclick="deletePost(${post.id})" title="Xóa hẳn">
                        <i class="bi bi-trash"></i>
                    </button>
                `;
            } else if (currentUser?.userRole === 'ContentManager' && isOwner) {
                // ContentManager: chỉ xóa hẳn được bài của mình ở trạng thái chờ duyệt
                if (post.status === 1) {
                    actionButtons += `
                        <button class="btn btn-sm btn-outline-danger" onclick="deletePost(${post.id})" title="Xóa hẳn">
                            <i class="bi bi-trash"></i>
                        </button>
                    `;
                }
            }

            const row = `
                <tr>
                    <td class="fw-bold">${post.title || ''}</td>
                    <td><span class="badge ${typeBadge.class}">${typeBadge.text}</span></td>
                    <td><span class="badge bg-light text-dark">${scheduleDate}</span></td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                    <td>${nguoiDang}</td>
                    <td>
                        <div class="d-flex gap-1">
                            ${actionButtons}
                        </div>
                    </td>
                </tr>
            `;
            tbody.append(row);
        });
    }

    // Thu hồi bài (chuyển từ đã duyệt về chờ duyệt)
    function recallPost(id) {
        if (confirm('Thu hồi bài viết này về trạng thái chờ duyệt?')) {
            $.ajax({
                url: '/Admin/Facebook/DeleteScheculePostFaceBooke',
                type: 'GET',
                data: {
                    id: id,
                    status: 1 // Chuyển về chờ duyệt
                },
                success: function (response) {
                    if (response.success) {
                        alert('Đã thu hồi bài viết về trạng thái chờ duyệt');
                        loadPosts(currentPage);
                        refreshStats();
                    } else {
                        alert(response.message || 'Có lỗi xảy ra');
                    }
                },
                error: function () {
                    alert('Không thể thu hồi bài viết');
                }
            });
        }
    }

    // Get status class
    function getStatusClass(status) {
        switch (status) {
            case 1: return 'bg-warning';
            case 2: return 'bg-success';
            case 3: return 'bg-secondary';
            case 4: return 'bg-info';
            default: return 'bg-secondary';
        }
    }

    // Get status text
    function getStatusText(status) {
        switch (status) {
            case 1: return 'Chờ duyệt';
            case 2: return 'Đã duyệt';
            case 3: return 'Đã đăng';
            default: return 'Không xác định';
        }
    }

    // Get type badge
    function getTypeBadge(type) {
        switch (type) {
            case 'activity': return { class: 'bg-info', text: 'Hoạt động' };
            case 'event': return { class: 'bg-success', text: 'Sự kiện' };
            case 'recruitment': return { class: 'bg-primary', text: 'Tuyển dụng' };
            case 'tech': return { class: 'bg-dark', text: 'Công nghệ' };
            case 'partner': return { class: 'bg-warning text-dark', text: 'Đối tác' };
            default: return { class: 'bg-secondary', text: 'Khác' };
        }
    }

    // Update weekly schedule
    // Update weekly schedule với tất cả bài viết
    function updateWeeklySchedule(posts) {
        const wrapper = $('#weeklySchedule');
        wrapper.empty();

        const today = new Date();
        const weekDays = [];

        // Lấy ngày đầu tuần (Thứ 2)
        const firstDayOfWeek = new Date(today);
        const day = today.getDay(); // 0: Chủ nhật, 1: Thứ 2, ..., 6: Thứ 7
        const diff = day === 0 ? 6 : day - 1; // Nếu Chủ nhật thì lùi 6 ngày, nếu không thì lùi (day-1) ngày
        firstDayOfWeek.setDate(today.getDate() - diff);

        // Tạo mảng 7 ngày trong tuần (từ Thứ 2 đến Chủ nhật)
        for (let i = 0; i < 7; i++) {
            const date = new Date(firstDayOfWeek);
            date.setDate(firstDayOfWeek.getDate() + i);
            weekDays.push(date);
        }

        weekDays.forEach(date => {
            const dayName = getDayName(date);
            const dateStr = date.toLocaleDateString('vi-VN');
            const dateKey = date.toDateString();

            // Lọc tất cả bài viết có lịch đăng trong ngày (từ tất cả dữ liệu)
            const dayPosts = posts.filter(p => {
                if (p.scheduledDate) {
                    const postDate = new Date(p.scheduledDate);
                    return postDate.toDateString() === dateKey;
                }
                return false;
            });

            let content = '';
            if (dayPosts.length > 0) {
                // Sắp xếp theo giờ đăng
                dayPosts.sort((a, b) => new Date(a.scheduledDate) - new Date(b.scheduledDate));
                dayPosts.forEach(post => {
                    const postTime = new Date(post.scheduledDate).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                    const typeBadge = getTypeBadge(post.typePost);
                    const statusClass = getStatusClass(post.status);
                    const statusText = getStatusText(post.status);
                    // Lấy tên người dùng từ users array
                    let nguoiDang = 'N/A';
                    if (post.userCreateId) {
                        nguoiDang = getUserNameById(post.userCreateId);
                    } else if (post.userCreate?.fullName) {
                        nguoiDang = post.userCreate.fullName;
                    }

                    content += `
                                <div class="p-2 bg-white rounded mb-2 border">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-light text-secondary border">${postTime}</span>
                                        <span class="badge ${statusClass}">${statusText}</span>
                                    </div>
                                    <p class="mb-0 small mt-1 fw-bold">${post.title || ''}</p>
                                    <small class="badge ${typeBadge.class}">${typeBadge.text}</small><br>
                                        <small class="text-muted">Người đăng: ${nguoiDang || 'N/A'}</small>
                                </div>
                            `;
                });
            } else {
                content = '<div class="p-2 bg-white rounded border text-muted fst-italic">Chưa có lịch</div>';
            }

            const dayCard = `
                        <div class="day-card">
                            <div class="card bg-light h-100">
                                <div class="card-header bg-white py-2">
                                    <h6 class="mb-0">${dayName} - ${dateStr}</h6>
                                </div>
                                <div class="card-body p-2" style="max-height: 400px; overflow-y: auto;">
                                    ${content}
                                </div>
                            </div>
                        </div>
                    `;
            wrapper.append(dayCard);
        });
    }

    // Get day name in Vietnamese
    function getDayName(date) {
        const days = ['Chủ nhật', 'Thứ 2', 'Thứ 3', 'Thứ 4', 'Thứ 5', 'Thứ 6', 'Thứ 7'];
        return days[date.getDay()];
    }

    // Update pagination
    function updatePagination(page, totalPagesCount, total) {
        currentPage = page;
        totalPages = totalPagesCount;

        $('#pageStart').text(((page - 1) * pageSize) + 1);
        $('#pageEnd').text(Math.min(page * pageSize, total));
        $('#totalRecords').text(total);

        let paginationHtml = '';
        paginationHtml += `<li class="page-item ${page === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadPosts(${page - 1}); return false;">Trước</a>
                </li>`;

        let startPage = Math.max(1, page - 2);
        let endPage = Math.min(totalPagesCount, startPage + 4);
        startPage = Math.max(1, endPage - 4);

        for (let i = startPage; i <= endPage; i++) {
            paginationHtml += `<li class="page-item ${i === page ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadPosts(${i}); return false;">${i}</a>
                    </li>`;
        }

        paginationHtml += `<li class="page-item ${page === totalPagesCount ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadPosts(${page + 1}); return false;">Sau</a>
                </li>`;

        $('#pagination').html(paginationHtml);
    }

    // Mở editor để thêm bài mới
    // Mở editor để thêm bài mới
    function openFBEditor() {
        resetFBForm();
        currentFBPostId = 0;
        $('#fbPostId').val(0);
        $('#editorModalTitle').text('THÊM BÀI VIẾT MỚI');

        // Ẩn/hiện nút dựa trên role
        if (currentUser && currentUser.userRole === 'SuperAdmin') {
            $('#draftButton').hide(); // Ẩn nút Chờ duyệt
            $('#approveButton').show(); // Hiện nút Duyệt
        } else if (currentUser && currentUser.userRole === 'ContentManager') {
            $('#draftButton').show(); // Hiện nút Chờ duyệt
            $('#approveButton').hide(); // Ẩn nút Duyệt
        }

        const modal = new bootstrap.Modal(document.getElementById('fbEditorModal'));
        modal.show();

        // Khởi tạo CKEditor sau khi modal hiển thị
        setTimeout(initCKEditor, 500);
    }

    // Mở editor để sửa bài
    function editFBPost(id) {
        $.ajax({
            url: '/Admin/Facebook/GetAll',
            type: 'GET',
            data: { page: 1, pagesize: 100 },
            success: function (response) {
                if (response.success) {
                    const post = response.data.find(p => p.id === id);
                    if (post) {
                        resetFBForm();
                        currentFBPostId = id;
                        $('#fbPostId').val(id);
                        $('#editorModalTitle').text('CHỈNH SỬA BÀI VIẾT');
                        $('#fbPostTitle').val(post.title || '');
                        $('#fbPostType').val(post.typePost || 'activity');

                        // Ẩn/hiện nút dựa trên role
                        if (currentUser && currentUser.userRole === 'SuperAdmin') {
                            $('#draftButton').hide(); // Ẩn nút Chờ duyệt
                            $('#approveButton').show(); // Hiện nút Duyệt
                        } else if (currentUser && currentUser.userRole === 'ContentManager') {
                            $('#draftButton').show(); // Hiện nút Chờ duyệt
                            $('#approveButton').hide(); // Ẩn nút Duyệt
                        }

                        // ... phần còn lại giữ nguyên
                        if (post.scheduledDate) {
                            const date = new Date(post.scheduledDate);
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const day = String(date.getDate()).padStart(2, '0');
                            const hours = String(date.getHours()).padStart(2, '0');
                            const minutes = String(date.getMinutes()).padStart(2, '0');

                            $('#scheduleDate').val(`${year}-${month}-${day}`);
                            $('#scheduleTime').val(`${hours}:${minutes}`);
                        }

                        if (post.imageUrls) {
                            try {
                                // Parse image URLs và loại bỏ baseUrl nếu có
                                selectedImages = JSON.parse(post.imageUrls) || [];
                                // Đảm bảo đường dẫn ảnh đúng format
                                selectedImages = selectedImages.map(img => {
                                    if (img.startsWith(baseUrl)) {
                                        return img.replace(baseUrl, '');
                                    }
                                    return img;
                                });
                            } catch {
                                selectedImages = [];
                            }
                        } else {
                            selectedImages = [];
                        }

                        if (post.videoUrl) {
                            try {
                                let videoUrl = post.videoUrl;
                                // Loại bỏ baseUrl nếu có
                                if (videoUrl.startsWith(baseUrl)) {
                                    videoUrl = videoUrl.replace(baseUrl, '');
                                }
                                selectedVideos = [{
                                    url: videoUrl,
                                    thumbnail: getVideoThumbnail(videoUrl),
                                    type: getVideoType(videoUrl)
                                }];
                            } catch {
                                selectedVideos = [];
                            }
                        } else {
                            selectedVideos = [];
                        }

                        // Set content cho CKEditor
                        if (editorInstance) {
                            editorInstance.setData(post.message || '');
                        } else {
                            $('#fbEditor').val(post.message || '');
                        }

                        updateImageGrid();
                        updateVideoGrid();

                        const modal = new bootstrap.Modal(document.getElementById('fbEditorModal'));
                        modal.show();

                        // Khởi tạo CKEditor sau khi modal hiển thị
                        setTimeout(initCKEditor, 500);
                    }
                }
            }
        });
    }

    // Get video thumbnail
    function getVideoThumbnail(url) {
        if (url.includes('youtube.com') || url.includes('youtu.be')) {
            let videoId = '';
            if (url.includes('youtube.com/watch?v=')) {
                videoId = url.split('v=')[1]?.split('&')[0];
            } else if (url.includes('youtu.be/')) {
                videoId = url.split('youtu.be/')[1]?.split('?')[0];
            }
            if (videoId) {
                return `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
            }
        }
        return 'https://via.placeholder.com/300x200/6c757d/ffffff?text=Video';
    }

    // Get video type
    function getVideoType(url) {
        if (url.match(/\.(mp4|webm|ogg)$/i)) return 'mp4';
        if (url.includes('youtube.com') || url.includes('youtu.be')) return 'youtube';
        if (url.includes('vimeo.com')) return 'vimeo';
        return 'other';
    }

    // Xem trước bài viết từ danh sách
    function previewFBPost(id) {
        $.ajax({
            url: '/Admin/Facebook/GetAll',
            type: 'GET',
            data: { page: 1, pagesize: 100 },
            success: function (response) {
                if (response.success) {
                    const post = response.data.find(p => p.id === id);
                    if (post) {
                        let images = [];
                        if (post.imageUrls) {
                            try {
                                images = JSON.parse(post.imageUrls) || [];
                                // Thêm baseUrl cho preview
                                images = images.map(img => {
                                    if (!img.startsWith('http')) {
                                        return baseUrl + img;
                                    }
                                    return img;
                                });
                            } catch {
                                images = [];
                            }
                        }

                        let videos = [];
                        if (post.videoUrl) {
                            let videoUrl = post.videoUrl;
                            if (!videoUrl.startsWith('http')) {
                                videoUrl = baseUrl + videoUrl;
                            }
                            videos = [{
                                url: videoUrl,
                                thumbnail: getVideoThumbnail(videoUrl),
                                type: getVideoType(videoUrl)
                            }];
                        }

                        let scheduleDisplay = '';
                        let postDateTime = '';
                        if (post.scheduledDate) {
                            const dateObj = new Date(post.scheduledDate);
                            scheduleDisplay = dateObj.toLocaleDateString('vi-VN') + ' ' +
                                dateObj.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

                            // Format thời gian đăng cho preview
                            const hours = dateObj.getHours().toString().padStart(2, '0');
                            const minutes = dateObj.getMinutes().toString().padStart(2, '0');
                            const day = dateObj.getDate().toString().padStart(2, '0');
                            const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                            const year = dateObj.getFullYear();
                            postDateTime = `${hours}:${minutes} - ${day}/${month}/${year}`;
                        }

                        // Loại bỏ thẻ HTML khỏi nội dung
                        let plainContent = post.message || '';
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = plainContent;
                        plainContent = tempDiv.textContent || tempDiv.innerText || '';
                        plainContent = plainContent.replace(/\s+/g, ' ').trim();

                        const postData = {
                            title: post.title,
                            content: plainContent,
                            type: post.typePost,
                            typeText: getTypeBadge(post.typePost).text,
                            typeClass: getTypeBadge(post.typePost).class,
                            scheduleDate: post.scheduledDate ? new Date(post.scheduledDate).toLocaleDateString('vi-VN') : '',
                            scheduleTime: post.scheduledDate ? new Date(post.scheduledDate).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }) : '',
                            scheduleDisplay: scheduleDisplay,
                            postDateTime: postDateTime, // Thêm trường này
                            images: images,
                            videos: videos
                        };
                        showPreview(postData);
                    }
                }
            }
        });
    }

    // Duyệt bài
    function approvePost(id) {
        if (confirm('Duyệt bài viết này?')) {
            $.ajax({
                url: '/Admin/Facebook/ScheculePostFacebook',
                type: 'GET',
                data: { id: id },
                success: function (response) {
                    if (response.success) {
                        alert('Đã duyệt bài viết thành công');
                        loadPosts(currentPage);
                        refreshStats();
                    } else {
                        alert(response.message || 'Có lỗi xảy ra');
                    }
                },
                error: function () {
                    alert('Không thể duyệt bài viết');
                }
            });
        }
    }

    // Lên lịch đăng bài
    function schedulePost(id) {
        if (confirm('Lên lịch đăng bài viết này?')) {
            $.ajax({
                url: '/Admin/Facebook/ScheculePostFacebook',
                type: 'GET',
                data: { id: id },
                success: function (response) {
                    if (response.success) {
                        alert('Đã lên lịch đăng bài thành công');
                        loadPosts(currentPage);
                        refreshStats();
                    } else {
                        alert(response.message || 'Có lỗi xảy ra');
                    }
                },
                error: function () {
                    alert('Không thể lên lịch đăng bài');
                }
            });
        }
    }

    // Xóa bài - XÓA HẲN LUÔN
    function deletePost(id) {
        if (confirm('Bạn có chắc chắn muốn xóa hẳn bài viết này?')) {
            // Lấy danh sách ảnh để xóa (nếu cần)
            const post = allPosts.find(p => p.id === id);

            $.ajax({
                url: '/Admin/Facebook/DeleteScheculePostFaceBooke',
                type: 'GET',
                data: {
                    id: id,
                    status: 0 // Luôn gửi status = 0 để xóa hẳn
                },
                success: function (response) {
                    if (response.success) {
                        // Nếu có ảnh, có thể gọi API xóa file (tùy chọn)
                        if (post && post.imageUrls) {
                            try {
                                const images = JSON.parse(post.imageUrls);
                                console.log('Có thể xóa các file ảnh:', images);
                                // Gọi API xóa file nếu cần
                                // deleteFiles(images);
                            } catch (e) {
                                console.error('Lỗi parse image URLs:', e);
                            }
                        }

                        // Thông báo thành công
                        alert('Đã xóa hẳn bài viết thành công');

                        // Tải lại dữ liệu
                        loadPosts(currentPage);
                        refreshStats();
                    } else {
                        alert(response.message || 'Có lỗi xảy ra khi xóa bài viết');
                    }
                },
                error: function () {
                    alert('Không thể kết nối đến server');
                }
            });
        }
    }

    // Mở File Manager
    function openFBFileManager(type) {
        fbFmType = type;
        new bootstrap.Modal(document.getElementById('fbFileManagerModal')).show();
    }

    // Nhận URL từ File Manager
    window.addEventListener('message', function (event) {
        if (event.data && event.data.type === 'getFileUrl') {
            const urls = event.data.url;

            if (fbFmType === 'image') {
                if (Array.isArray(urls)) {
                    urls.forEach(imgUrl => {
                        // Lưu đường dẫn tương đối (loại bỏ domain)
                        let relativeUrl = imgUrl;
                        if (imgUrl.startsWith(baseUrl)) {
                            relativeUrl = imgUrl.replace(baseUrl, '');
                        }
                        if (!selectedImages.includes(relativeUrl)) {
                            selectedImages.push(relativeUrl);
                        }
                    });
                } else {
                    let relativeUrl = urls;
                    if (urls.startsWith(baseUrl)) {
                        relativeUrl = urls.replace(baseUrl, '');
                    }
                    if (!selectedImages.includes(relativeUrl)) {
                        selectedImages.push(relativeUrl);
                    }
                }
                updateImageGrid();
            } else if (fbFmType === 'video') {
                if (Array.isArray(urls)) {
                    urls.forEach(videoUrl => {
                        let relativeUrl = videoUrl;
                        if (videoUrl.startsWith(baseUrl)) {
                            relativeUrl = videoUrl.replace(baseUrl, '');
                        }
                        if (!selectedVideos.some(v => v.url === relativeUrl)) {
                            selectedVideos.push({
                                url: relativeUrl,
                                thumbnail: getVideoThumbnail(relativeUrl),
                                type: getVideoType(relativeUrl)
                            });
                        }
                    });
                } else {
                    let relativeUrl = urls;
                    if (urls.startsWith(baseUrl)) {
                        relativeUrl = urls.replace(baseUrl, '');
                    }
                    if (!selectedVideos.some(v => v.url === relativeUrl)) {
                        selectedVideos.push({
                            url: relativeUrl,
                            thumbnail: getVideoThumbnail(relativeUrl),
                            type: getVideoType(relativeUrl)
                        });
                    }
                }
                updateVideoGrid();
            }

            bootstrap.Modal.getInstance(document.getElementById('fbFileManagerModal')).hide();
        }
    });

    // Cập nhật grid ảnh
    function updateImageGrid() {
        const grid = document.getElementById('fbImageGrid');
        if (!grid) return;

        grid.innerHTML = '';

        selectedImages.forEach((imgUrl, index) => {
            const imgDiv = document.createElement('div');
            imgDiv.className = 'image-item position-relative';
            imgDiv.style.width = '80px';
            imgDiv.style.height = '80px';

            // Thêm baseUrl để hiển thị ảnh
            const displayUrl = imgUrl.startsWith('http') ? imgUrl : baseUrl + imgUrl;

            imgDiv.innerHTML = `
                        <img src="${displayUrl}" class="rounded border" style="width:100%; height:100%; object-fit:cover;">
                        <button class="btn btn-sm btn-danger position-absolute top-0 end-0" style="padding:0 5px;" onclick="removeImage(${index})">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    `;

            grid.appendChild(imgDiv);
        });

        const addDiv = document.createElement('div');
        addDiv.className = 'image-placeholder text-center p-3 bg-light rounded';
        addDiv.style.width = '80px';
        addDiv.style.height = '80px';
        addDiv.style.cursor = 'pointer';
        addDiv.onclick = () => openFBFileManager('image');
        addDiv.innerHTML = `
                    <i class="bi bi-plus-circle text-muted"></i>
                    <small class="d-block">Thêm ảnh</small>
                `;

        grid.appendChild(addDiv);
    }

    // Xóa ảnh
    function removeImage(index) {
        // Nếu cần xóa file vật lý, có thể gọi API ở đây
        // deleteFile(selectedImages[index]);
        selectedImages.splice(index, 1);
        updateImageGrid();
    }

    // Cập nhật grid video
    function updateVideoGrid() {
        const grid = document.getElementById('fbVideoGrid');
        if (!grid) return;

        grid.innerHTML = '';

        selectedVideos.forEach((video, index) => {
            const videoDiv = document.createElement('div');
            videoDiv.className = 'video-item position-relative';
            videoDiv.style.width = '80px';
            videoDiv.style.height = '80px';

            // Thêm baseUrl cho thumbnail nếu là đường dẫn local
            const thumbnailUrl = video.thumbnail.startsWith('http') ? video.thumbnail : baseUrl + video.thumbnail;

            videoDiv.innerHTML = `
                        <img src="${thumbnailUrl}" class="rounded border" style="width:100%; height:100%; object-fit:cover;">
                        <span class="position-absolute bottom-0 start-0 bg-dark text-white p-1 rounded" style="font-size: 10px;">
                            <i class="bi bi-camera-video"></i>
                        </span>
                        <button class="btn btn-sm btn-danger position-absolute top-0 end-0" style="padding:0 5px;" onclick="removeVideo(${index})">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    `;

            grid.appendChild(videoDiv);
        });

        const addDiv = document.createElement('div');
        addDiv.className = 'video-placeholder text-center p-3 bg-light rounded';
        addDiv.style.width = '80px';
        addDiv.style.height = '80px';
        addDiv.style.cursor = 'pointer';
        addDiv.onclick = () => openFBFileManager('video');
        addDiv.innerHTML = `
                    <i class="bi bi-plus-circle text-muted"></i>
                    <small class="d-block">Thêm video</small>
                `;

        grid.appendChild(addDiv);
    }

    // Xóa video
    function removeVideo(index) {
        // Nếu cần xóa file vật lý, có thể gọi API ở đây
        // deleteFile(selectedVideos[index].url);
        selectedVideos.splice(index, 1);
        updateVideoGrid();
    }

    // Tạo nội dung tự động
    function generateAIContent() {
        const type = $('#fbPostType').val();
        const title = $('#fbPostTitle').val();

        if (!title) {
            alert('Vui lòng nhập tiêu đề trước khi tạo nội dung');
            return;
        }

        const generateBtn = event.target;
        const originalText = generateBtn.innerHTML;
        generateBtn.innerHTML = '<i class="bi bi-arrow-repeat me-1 spinner"></i>Đang tạo...';
        generateBtn.disabled = true;

        setTimeout(() => {
            let content = '';

            switch (type) {
                case 'activity':
                    content = `<p>📸 <strong>${title}</strong></p>
        <p>Hôm nay, đội ngũ VDCD Group đã có một ngày hoạt động thật ý nghĩa và sôi động. Chúng ta đã cùng nhau tham gia nhiều hoạt động thú vị, gắn kết tình đồng đội và tạo ra những kỷ niệm đẹp.</p>
        <p>✨ <strong>Những điểm nhấn trong ngày:</strong></p>
        <ul>
        <li>Hoạt động team building sôi nổi</li>
        <li>Chia sẻ kinh nghiệm làm việc</li>
        <li>Giao lưu văn nghệ</li>
        </ul>
        <p>Cảm ơn tất cả mọi người đã tham gia và tạo nên thành công cho chương trình! ❤️</p>`;
                    break;
                case 'event':
                    content = `<p>🎉 <strong>${title}</strong></p>
        <p>VDCD Group trân trọng thông báo về sự kiện sắp tới dành cho tất cả các thành viên và đối tác.</p>
        <p>📅 <strong>Thời gian:</strong> ${$('#scheduleDate').val()} lúc ${$('#scheduleTime').val()}<br>
        📍 <strong>Địa điểm:</strong> Tòa nhà VDCD, Hà Nội</p>
        <p>✨ <strong>Nội dung chương trình:</strong></p>
        <ul>
        <li>Chia sẻ từ chuyên gia hàng đầu</li>
        <li>Workshop thực hành</li>
        <li>Networking với các doanh nghiệp</li>
        </ul>
        <p>Đăng ký ngay: https://vdcd.vn/event</p>`;
                    break;
                case 'recruitment':
                    content = `<p>💼 <strong>${title}</strong></p>
        <p>VDCD Group đang tìm kiếm những ứng viên tài năng để gia nhập đội ngũ phát triển của chúng tôi.</p>
        <p>✅ <strong>Yêu cầu:</strong></p>
        <ul>
        <li>Kinh nghiệm 3-5 năm trong lĩnh vực</li>
        <li>Kỹ năng làm việc nhóm tốt</li>
        <li>Tiếng Anh giao tiếp</li>
        </ul>
        <p>✅ <strong>Quyền lợi:</strong></p>
        <ul>
        <li>Mức lương hấp dẫn</li>
        <li>Môi trường làm việc chuyên nghiệp</li>
        <li>Cơ hội thăng tiến cao</li>
        </ul>
        <p>Ứng tuyển ngay: https://vdcd.vn/tuyen-dung</p>`;
                    break;
                case 'tech':
                    content = `<p>💡 <strong>${title}</strong></p>
        <p>Xin chào mọi người! Hôm nay mình xin chia sẻ về một công nghệ mới mà đội ngũ VDCD đang áp dụng.</p>
        <p>🔧 <strong>Công nghệ chính:</strong></p>
        <ul>
        <li>.NET Core 8.0</li>
        <li>ReactJS với TypeScript</li>
        <li>Microservices architecture</li>
        </ul>
        <p>📝 <strong>Bài học rút ra:</strong></p>
        <ul>
        <li>Tối ưu hiệu suất</li>
        <li>Bảo mật tốt hơn</li>
        <li>Dễ dàng mở rộng</li>
        </ul>
        <p>Các bạn có thắc mắc gì cứ comment bên dưới nhé! 👨‍💻</p>`;
                    break;
                case 'partner':
                    content = `<p>🤝 <strong>${title}</strong></p>
        <p>VDCD Group hân hạnh giới thiệu đối tác mới của chúng tôi - một trong những công ty hàng đầu trong lĩnh vực công nghệ.</p>
        <p>✅ <strong>Lợi ích hợp tác:</strong></p>
        <ul>
        <li>Mở rộng mạng lưới đối tác</li>
        <li>Phát triển giải pháp tích hợp</li>
        <li>Cơ hội học hỏi và phát triển</li>
        </ul>
        <p>Chúng tôi tin rằng sự hợp tác này sẽ mang lại nhiều giá trị cho cả hai bên và khách hàng. 🚀</p>`;
                    break;
                default:
                    content = `<p>📝 <strong>${title}</strong></p>
        <p>VDCD Group xin gửi đến mọi người thông tin mới nhất về hoạt động của công ty trong thời gian qua.</p>
        <p>✅ <strong>Những điểm nổi bật:</strong></p>
        <ul>
        <li>Hoàn thành dự án quan trọng</li>
        <li>Mở rộng đội ngũ nhân sự</li>
        <li>Hợp tác với đối tác mới</li>
        </ul>
        <p>Cảm ơn mọi người đã luôn đồng hành cùng VDCD Group!</p>`;
            }

            if (editorInstance) {
                editorInstance.setData(content);
            } else {
                $('#fbEditor').val(content);
            }

            generateBtn.innerHTML = originalText;
            generateBtn.disabled = false;

            alert('Đã tạo nội dung tự động thành công!');
        }, 1500);
    }

    // Xem trước bài viết hiện tại
    function previewCurrentPost() {
        const title = $('#fbPostTitle').val() || '(Chưa có tiêu đề)';

        // Lấy nội dung và loại bỏ thẻ HTML cho preview
        let rawContent = editorInstance ? editorInstance.getData() : '';
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = rawContent;
        let content = tempDiv.textContent || tempDiv.innerText || '';
        content = content.replace(/\s+/g, ' ').trim();

        const type = $('#fbPostType').val();
        const scheduleDate = $('#scheduleDate').val();
        const scheduleTime = $('#scheduleTime').val();

        let typeText = 'Nội dung khác';
        let typeClass = 'bg-secondary';

        switch (type) {
            case 'activity':
                typeText = 'Hoạt động';
                typeClass = 'bg-info';
                break;
            case 'event':
                typeText = 'Sự kiện';
                typeClass = 'bg-success';
                break;
            case 'recruitment':
                typeText = 'Tuyển dụng';
                typeClass = 'bg-primary';
                break;
            case 'tech':
                typeText = 'Công nghệ';
                typeClass = 'bg-dark';
                break;
            case 'partner':
                typeText = 'Đối tác';
                typeClass = 'bg-warning text-dark';
                break;
        }

        let scheduleDisplay = '';
        let postDateTime = '';
        if (scheduleDate && scheduleTime) {
            const dateObj = new Date(scheduleDate + 'T' + scheduleTime);
            scheduleDisplay = dateObj.toLocaleDateString('vi-VN') + ' ' + scheduleTime;

            // Format thời gian đăng cho preview (VD: 09:00 - 20/03/2024)
            const hours = dateObj.getHours().toString().padStart(2, '0');
            const minutes = dateObj.getMinutes().toString().padStart(2, '0');
            const day = dateObj.getDate().toString().padStart(2, '0');
            const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
            const year = dateObj.getFullYear();
            postDateTime = `${hours}:${minutes} - ${day}/${month}/${year}`;
        }

        // Thêm baseUrl cho ảnh và video preview
        const imagesForPreview = selectedImages.map(img => {
            if (!img.startsWith('http')) {
                return baseUrl + img;
            }
            return img;
        });

        const videosForPreview = selectedVideos.map(video => {
            let videoUrl = video.url;
            if (!videoUrl.startsWith('http')) {
                videoUrl = baseUrl + videoUrl;
            }
            let thumbnail = video.thumbnail;
            if (!thumbnail.startsWith('http')) {
                thumbnail = baseUrl + thumbnail;
            }
            return {
                url: videoUrl,
                thumbnail: thumbnail,
                type: video.type
            };
        });

        const postData = {
            title: title,
            content: content || 'Chưa có nội dung',
            type: type,
            typeText: typeText,
            typeClass: typeClass,
            scheduleDate: scheduleDate ? new Date(scheduleDate).toLocaleDateString('vi-VN') : '',
            scheduleTime: scheduleTime || '',
            scheduleDisplay: scheduleDisplay,
            postDateTime: postDateTime, // Thêm trường này
            images: imagesForPreview,
            videos: videosForPreview
        };

        showPreview(postData);
    }

    // Hiển thị preview
    function showPreview(postData) {
        $('#previewContent').text(postData.content || 'Chưa có nội dung');

        // Hiển thị thời gian đăng thực tế
        if (postData.postDateTime) {
            $('#previewDateTime').text(postData.postDateTime);
        } else {
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ':' +
                now.getMinutes().toString().padStart(2, '0');
            $('#previewDateTime').text(`Hôm nay lúc ${timeStr}`);
        }

        if (postData.scheduleDisplay) {
            $('#previewScheduleText').text(postData.scheduleDisplay);
            $('#previewSchedule').show();
        } else {
            $('#previewSchedule').hide();
        }

        const imagesContainer = $('#previewImages');
        imagesContainer.empty();

        if (postData.images && postData.images.length > 0) {
            if (postData.images.length === 1) {
                imagesContainer.html(`
                            <div class="single-image">
                                <img src="${postData.images[0]}" class="img-fluid rounded" style="max-height: 250px; width: 100%; object-fit: cover;">
                            </div>
                        `);
            } else if (postData.images.length === 2) {
                imagesContainer.html(`
                            <div class="row g-1">
                                <div class="col-6"><img src="${postData.images[0]}" class="img-fluid rounded" style="height: 120px; width: 100%; object-fit: cover;"></div>
                                <div class="col-6"><img src="${postData.images[1]}" class="img-fluid rounded" style="height: 120px; width: 100%; object-fit: cover;"></div>
                            </div>
                        `);
            } else if (postData.images.length >= 3) {
                imagesContainer.html(`
                            <div class="row g-1">
                                <div class="col-4"><img src="${postData.images[0]}" class="img-fluid rounded" style="height: 80px; width: 100%; object-fit: cover;"></div>
                                <div class="col-4"><img src="${postData.images[1]}" class="img-fluid rounded" style="height: 80px; width: 100%; object-fit: cover;"></div>
                                <div class="col-4"><img src="${postData.images[2]}" class="img-fluid rounded" style="height: 80px; width: 100%; object-fit: cover;"></div>
                            </div>
                            ${postData.images.length > 3 ? '<div class="text-muted small mt-1">+' + (postData.images.length - 3) + ' ảnh khác</div>' : ''}
                        `);
            }
        }

        const videosContainer = $('#previewVideos');
        videosContainer.empty();

        if (postData.videos && postData.videos.length > 0) {
            if (postData.videos.length === 1) {
                const video = postData.videos[0];
                videosContainer.html(`
                            <div class="single-video position-relative">
                                <img src="${video.thumbnail}" class="img-fluid rounded" style="max-height: 250px; width: 100%; object-fit: cover;">
                                <span class="position-absolute top-50 start-50 translate-middle bg-dark bg-opacity-75 text-white rounded-circle p-3" style="font-size: 24px; cursor: pointer;" onclick="window.open('${video.url}', '_blank')">
                                    <i class="bi bi-play-fill"></i>
                                </span>
                                <div class="position-absolute bottom-0 start-0 bg-dark text-white p-1 rounded small m-1">
                                    <i class="bi bi-camera-video me-1"></i>Video
                                </div>
                            </div>
                        `);
            } else {
                let html = '<div class="row g-1">';
                postData.videos.forEach(video => {
                    html += `
                                <div class="col-6 position-relative">
                                    <img src="${video.thumbnail}" class="img-fluid rounded" style="height: 120px; width: 100%; object-fit: cover;">
                                    <span class="position-absolute top-50 start-50 translate-middle bg-dark bg-opacity-75 text-white rounded-circle p-2" style="font-size: 16px; cursor: pointer;" onclick="window.open('${video.url}', '_blank')">
                                        <i class="bi bi-play-fill"></i>
                                    </span>
                                </div>
                            `;
                });
                html += '</div>';
                videosContainer.html(html);
            }
        }

        new bootstrap.Modal(document.getElementById('fbPreviewModal')).show();
    }

    // Reset form
    function resetFBForm() {
        $('#fbPostId').val(0);
        $('#fbPostTitle').val('');
        $('#fbPostType').val('activity');
        $('#fbEditor').val('');
        $('#scheduleDate').val('@DateTime.Now.AddDays(1).ToString("yyyy-MM-dd")');
        $('#scheduleTime').val('09:00');

        selectedImages = [];
        selectedVideos = [];
        updateImageGrid();
        updateVideoGrid();

        if (editorInstance) {
            editorInstance.setData('');
        }
    }

    // Đặt khung giờ vàng
    function setGoldenHour(time) {
        $('#scheduleTime').val(time);
    }

    // Lưu nháp (Chờ duyệt)
    function saveAsDraft() {
        savePost(1);
    }

    // Lưu và lên lịch
    function saveAndSchedule() {
        savePost(2);
    }

    // Lưu bài viết
    function savePost(status) {
        const title = $('#fbPostTitle').val();
        if (!title) {
            alert('Vui lòng nhập tiêu đề bài viết');
            return;
        }

        const content = editorInstance ? editorInstance.getData() : '';
        if (!content) {
            alert('Vui lòng nhập nội dung bài viết');
            return;
        }

        const scheduleDate = $('#scheduleDate').val();
        const scheduleTime = $('#scheduleTime').val();

        const scheduleDateTime = scheduleDate && scheduleTime
            ? `${scheduleDate}T${scheduleTime}:00`
            : null;

        console.log(scheduleDateTime);

        // Lưu đường dẫn tương đối (không có domain)
        // Lưu đường dẫn đầy đủ (có domain)
        const imageUrlsForSave = selectedImages.map(img => {
            if (img.startsWith('http')) {
                return img;
            }
            return baseUrl + img;
        });

        const videoUrlForSave = selectedVideos.length > 0
            ? (selectedVideos[0].url.startsWith('http') ? selectedVideos[0].url : baseUrl + selectedVideos[0].url)
            : null;
        const postData = {
            Id: currentFBPostId || 0,
            title: title,
            Messgase: content,
            type: $('#fbPostType').val(),
            scheduleDate: scheduleDateTime,
            ImageUrls: imageUrlsForSave,
            Videos: videoUrlForSave
        };

        const $btn = $(event.target);
        const originalText = $btn.html();
        $btn.html('<i class="bi bi-arrow-repeat me-1 spinner"></i>Đang lưu...').prop('disabled', true);

        $.ajax({
            url: '/Admin/Facebook/FaceBookPosts',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(postData),
            success: function (response) {
                $btn.html(originalText).prop('disabled', false);

                if (response.success) {
                    alert(status === 1 ? 'Đã lưu bài viết chờ duyệt' : 'Đã lưu và lên lịch đăng bài');
                    bootstrap.Modal.getInstance(document.getElementById('fbEditorModal')).hide();
                    loadPosts(currentPage);
                    refreshStats();
                } else {
                    alert(response.message || 'Có lỗi xảy ra');
                }
            },
            error: function () {
                $btn.html(originalText).prop('disabled', false);
                alert('Không thể lưu bài viết');
            }
        });
    }

    // Filter and search
    $('#searchInput').on('keyup', function () {
        filterPosts();
    });

    $('#statusFilter').on('change', function () {
        filterPosts();
    });

    $('#typeFilter').on('change', function () {
        filterPosts();
    });

    $('#userFilter').on('change', function () {
        filterPosts();
    });

    $('#pageSize').on('change', function () {
        pageSize = parseInt($(this).val());
        currentPage = 1;
        filterPosts();
    });

    // Debounce function để tránh gọi API quá nhiều khi gõ
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    function filterPosts() {
        const searchTerm = $('#searchInput').val().toLowerCase().trim();
        const statusFilter = $('#statusFilter').val();
        const typeFilter = $('#typeFilter').val();
        const userFilter = $('#userFilter').val();

        $.ajax({
            url: '/Admin/Facebook/GetAll',
            type: 'GET',
            data: {
                page: currentPage,
                pagesize: pageSize
            },
            success: function (response) {
                if (response.success) {
                    let filteredData = response.data;

                    // Lọc theo tiêu đề
                    if (searchTerm) {
                        filteredData = filteredData.filter(p =>
                            p.title && p.title.toLowerCase().includes(searchTerm)
                        );
                    }

                    // Lọc theo trạng thái
                    if (statusFilter) {
                        filteredData = filteredData.filter(p => p.status == statusFilter);
                    }

                    // Lọc theo loại bài viết
                    if (typeFilter) {
                        filteredData = filteredData.filter(p => p.typePost === typeFilter);
                    }

                    // Lọc theo người đăng
                    if (userFilter) {
                        filteredData = filteredData.filter(p => p.userCreateId == userFilter);
                    }

                    // Cập nhật phân trang cho dữ liệu đã lọc
                    const totalFiltered = filteredData.length;
                    const totalPagesFiltered = Math.ceil(totalFiltered / pageSize);

                    // Lấy dữ liệu cho trang hiện tại
                    const startIndex = (currentPage - 1) * pageSize;
                    const paginatedData = filteredData.slice(startIndex, startIndex + pageSize);

                    renderPosts(paginatedData);
                    updatePagination(currentPage, totalPagesFiltered, totalFiltered);
                }
            },
            error: function () {
                toastr.error('Không thể tải danh sách bài viết');
            }
        });
    }

    // Initialize
    $(document).ready(function () {
        getCurrentUser();
        loadPosts(1);
    });

    // Load danh sách người dùng vào combobox lọc
    function loadUserFilter() {
        const $userFilter = $('#userFilter');
        $userFilter.empty().append('<option value="">Tất cả người đăng</option>');

        if (users && users.length > 0) {
            // Tạo một Set để lọc các user duy nhất (tránh trùng lặp)
            const uniqueUsers = [];
            const userIds = new Set();

            users.forEach(user => {
                if (!userIds.has(user.userId)) {
                    userIds.add(user.userId);
                    uniqueUsers.push(user);
                }
            });

            // Sắp xếp theo tên
            uniqueUsers.sort((a, b) => (a.fullName || '').localeCompare(b.fullName || ''));

            uniqueUsers.forEach(user => {
                $userFilter.append(`<option value="${user.userId}">${user.fullName || 'Không tên'}</option>`);
            });
        }
    }
</script>

<style>
    .border-left-primary {
        border-left: 4px solid #0d6efd;
    }

    .border-left-warning {
        border-left: 4px solid #ffc107;
    }

    .table td {
        vertical-align: middle;
    }

    .week-scroll-container {
        width: 100%;
        overflow-x: auto;
        overflow-y: hidden;
        padding-bottom: 10px;
        margin-bottom: 5px;
        scrollbar-width: thin;
        scrollbar-color: #c0c0c0 #f0f0f0;
    }

    .week-scroll-wrapper {
        display: flex;
        flex-direction: row;
        gap: 15px;
        min-width: min-content;
    }

    .day-card {
        flex: 0 0 280px;
        min-width: 280px;
        max-width: 280px;
    }

    .week-scroll-container::-webkit-scrollbar {
        height: 8px;
    }

    .week-scroll-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .week-scroll-container::-webkit-scrollbar-thumb {
        background: #c0c0c0;
        border-radius: 10px;
    }

        .week-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #a0a0a0;
        }

    .day-card .card {
        height: 100%;
        min-height: 160px;
    }

        .day-card .card:hover {
            transform: translateY(-2px);
            transition: transform 0.2s;
        }

    .ck-editor__editable {
        min-height: 250px;
        max-height: 400px;
    }

    .ck-content {
        font-size: 14px;
        line-height: 1.6;
    }

        .ck-content h2 {
            font-size: 1.5rem;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }

        .ck-content h3 {
            font-size: 1.25rem;
            margin-top: 0.75rem;
            margin-bottom: 0.5rem;
        }

    .image-item, .video-item {
        position: relative;
        cursor: pointer;
        transition: transform 0.2s;
    }

        .image-item:hover, .video-item:hover {
            transform: scale(1.05);
        }

        .image-item .btn-danger, .video-item .btn-danger {
            opacity: 0;
            transition: opacity 0.2s;
        }

        .image-item:hover .btn-danger, .video-item:hover .btn-danger {
            opacity: 1;
        }

    .image-placeholder, .video-placeholder {
        cursor: pointer;
        transition: all 0.2s;
    }

        .image-placeholder:hover, .video-placeholder:hover {
            background-color: #e9ecef !important;
        }

    .facebook-post {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        background: white;
    }

    .post-header {
        border-bottom: 1px solid #f0f0f0;
    }

    .post-content {
        font-size: 14px;
    }

        .post-content p {
            margin-bottom: 8px;
        }

        .post-content ul, .post-content ol {
            margin-bottom: 8px;
            padding-left: 20px;
        }

    .post-footer span {
        cursor: default;
        padding: 4px 8px;
        border-radius: 4px;
    }

        .post-footer span:hover {
            background: #f0f2f5;
        }

    .spinner {
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .single-video .bi-play-fill {
        font-size: 24px;
    }

    @@media (max-width: 768px) {
        .day-card {
            flex: 0 0 240px;
            min-width: 240px;
        }
    }

    .rounded {
        cursor: pointer;
    }

</style>